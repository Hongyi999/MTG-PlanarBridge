# 🧪 MTG PlanarBridge - 测试清单

## 测试前准备

### 1. 环境配置检查
```bash
# 确认 Node.js 版本 (需要 >= 18)
node --version

# 安装依赖
npm install

# 初始化 FAB 卡牌数据子模块
git submodule update --init --recursive

# 确认 .env 文件存在
cp .env.example .env
```

### 2. 数据库设置
```bash
# 确保 DATABASE_URL 已配置
# 编辑 .env 文件，设置：
# DATABASE_URL=postgresql://user:password@localhost:5432/mtg_planar_bridge
```

### 3. 构建项目
```bash
npm run build
```

---

## 🎯 功能测试清单

### ✅ 1. 日本价格隐藏 (MVP)
**测试点：**
- [ ] 卡牌详情页不显示日本市场价格卡片
- [ ] "我的" 页面导出选项中没有日元相关选项
- [ ] 价格列表导出中没有 Hareruya 或日元字段
- [ ] 价格历史图表中没有 JPY 线条

**测试步骤：**
1. 访问任意卡牌详情页（如 `/card/[scryfall_id]`）
2. 检查价格区域，确认只有 USD 和 CNY 价格
3. 进入 "我的" 页面 → "价格列表管理"
4. 检查导出选项，确认没有日元相关维度

---

### ✅ 2. 用户认证系统
**测试点：**
- [ ] 手机号验证码登录功能
- [ ] 微信昵称可选填写
- [ ] 登录后显示用户信息
- [ ] 退出登录功能
- [ ] Session 持久化（刷新页面不退出）

**测试步骤：**
1. 访问 `/login` 或点击 "我的" → "登录/注册"
2. 输入手机号（测试号码：13800138000）
3. 点击 "发送验证码"，查看控制台获取验证码（MVP 版本会在响应中返回）
4. 输入验证码登录
5. （首次登录）填写微信昵称（可选）
6. 确认跳转到 "我的" 页面，显示用户信息
7. 刷新页面，确认仍然保持登录状态
8. 点击 "退出登录"，确认返回登录页

**预期结果：**
- 验证码在控制台或响应中显示（MVP 测试）
- 登录成功后显示用户手机号和昵称
- Session 在刷新后保持

---

### ✅ 3. AI 自然语言搜索
**测试点：**
- [ ] 中文自然语言查询转换为 Scryfall 语法
- [ ] 显示解析后的查询说明
- [ ] 搜索结果准确

**测试查询：**
```
测试用例 1: "3费以下绿色生物"
预期转换: "cmc<=3 color:G type:creature"

测试用例 2: "蓝色瞬间或法术费用小于2"
预期转换: "color:U (type:instant OR type:sorcery) cmc<2"

测试用例 3: "现代赛制传奇生物带飞行"
预期转换: "format:modern type:legendary type:creature oracle:flying"

测试用例 4: "红色横置产生法术力"
预期转换: "color:R oracle:tap oracle:add"
```

**测试步骤：**
1. 访问 "卡牌库" 页面
2. 在搜索框输入上述测试用例
3. 查看搜索框下方的蓝色解析说明
4. 确认搜索结果符合预期

---

### ✅ 4. 聊天/私信功能
**测试点：**
- [ ] 发送私信
- [ ] 接收私信
- [ ] 未读消息显示
- [ ] 消息实时更新（3秒轮询）
- [ ] 搜索用户发起对话

**测试步骤：**
1. 登录两个不同账号（使用两个浏览器或无痕模式）
2. 账号 A：访问 `/chat`
3. 点击 "新对话" → 搜索账号 B 的手机号或昵称
4. 发送测试消息
5. 账号 B：访问 `/chat`，确认收到消息
6. 账号 B：回复消息
7. 账号 A：等待 3 秒，确认收到回复（自动刷新）
8. 确认未读消息数显示正确

**预期结果：**
- 消息实时显示（3秒内）
- 未读消息有红色徽章
- 对话列表显示最新消息预览

---

### ✅ 5. JustTCG 价格历史集成
**测试点：**
- [ ] 价格历史图表显示 3 条 USD 线
- [ ] JustTCG 数据正确显示

**测试步骤：**
1. 确保 `.env` 中配置了 `JUSTTCG_API_KEY`
2. 访问任意热门卡牌详情页
3. 查看价格历史图表
4. 确认有 3 条线：
   - Scryfall (蓝色)
   - TCGTracking (绿色)
   - JustTCG (紫色)
4. 鼠标悬停查看具体数值

**注意：** 如果没有 API key，JustTCG 线不会显示（这是正常的）

---

### ✅ 6. FAB (Flesh and Blood) 卡牌支持
**测试点：**
- [ ] 游戏切换器显示并工作
- [ ] FAB 卡牌搜索功能
- [ ] FAB 卡牌详情页
- [ ] Pitch 值颜色显示
- [ ] 卡牌属性正确展示

**测试步骤：**
1. 访问首页，查看右上角游戏选择器
2. 点击切换到 "血肉之躯 (FAB)"
3. 访问 "卡牌库" 页面
4. 搜索 "Rhinar" 或 "Fyendal"
5. 点击任意卡牌进入详情页
6. 确认显示：
   - 卡牌图片
   - Cost、Pitch、Power、Defense 等属性
   - Pitch 值对应的边框颜色（红1/黄2/蓝3）
   - 关键词（Keywords）
   - 所有印刷版本

**Pitch 颜色验证：**
- Pitch 1 → 红色边框
- Pitch 2 → 黄色边框
- Pitch 3 → 蓝色边框

---

### ✅ 7. FAB 卡牌缓存系统
**测试点：**
- [ ] 服务器启动时加载缓存
- [ ] 搜索性能快速（< 1ms）
- [ ] 缓存统计正确

**测试步骤：**
1. 启动服务器：`npm start`
2. 查看控制台日志，确认：
   ```
   [fab-cache] Loading FAB cards cache...
   [fab-cache] ✓ Loaded 4241 cards in ~250ms
   [fab-cache] FAB cache loaded: 4241 cards, 93 sets
   ```
3. 搜索 FAB 卡牌，确认响应速度快（< 100ms）

**性能测试：**
```bash
# 运行性能测试脚本
npx tsx test-fab-cache.ts
```

预期输出：
```
✅ Loaded 4241 cards in <300ms
✅ Search performance: ~0.4ms per query
✅ 1000 searches in <500ms
```

---

## 🔧 回归测试

### 基础功能（确保没有破坏）
- [ ] 万智牌搜索功能正常
- [ ] 卡牌详情页显示正常
- [ ] 价格列表创建/编辑功能正常
- [ ] 关注卡牌功能正常
- [ ] 社区动态发布/查看正常
- [ ] 文件上传功能正常

---

## 🌐 浏览器兼容性测试

测试浏览器：
- [ ] Chrome/Edge (推荐)
- [ ] Firefox
- [ ] Safari
- [ ] 移动端浏览器（iOS Safari / Android Chrome）

---

## 📊 性能测试

### 页面加载时间
- [ ] 首页加载 < 2秒
- [ ] 卡牌库搜索响应 < 1秒
- [ ] 卡牌详情页加载 < 1.5秒
- [ ] FAB 卡牌搜索响应 < 0.5秒（本地缓存）

### 内存使用
- [ ] 服务器启动后内存 < 200MB
- [ ] FAB 缓存加载后增加 ~80MB（正常）

---

## 🐛 已知问题/限制

### MVP 阶段限制：
1. **验证码功能**：验证码在响应中返回（生产环境需接入短信服务）
2. **JustTCG 价格**：需要 API key 才能显示
3. **实时聊天**：使用 3秒轮询（可升级为 WebSocket）
4. **智能搜索**：关键词匹配（可升级为 LLM）
5. **FAB 价格**：暂无价格数据（已准备 TCGPlayer ID）

---

## ✅ 合并前检查清单

在合并到 main 之前，确认：
- [ ] 所有测试用例通过
- [ ] 没有控制台错误（除预期的 API key 缺失警告）
- [ ] 构建成功无错误
- [ ] 文档已更新（README.md, FAB-INTEGRATION.md）
- [ ] 提交信息清晰
- [ ] 没有敏感信息（API keys, passwords）提交到代码库

---

## 📝 测试报告模板

```markdown
## 测试报告 - [日期]

**测试人员**: [姓名]
**测试环境**:
- Node.js: [版本]
- 浏览器: [浏览器和版本]
- 操作系统: [OS]

**功能测试结果**:
1. 日本价格隐藏: ✅ 通过 / ❌ 失败
2. 用户认证系统: ✅ 通过 / ❌ 失败
3. AI 自然语言搜索: ✅ 通过 / ❌ 失败
4. 聊天/私信功能: ✅ 通过 / ❌ 失败
5. JustTCG 价格历史: ✅ 通过 / ⚠️  未测试（无 API key）
6. FAB 卡牌支持: ✅ 通过 / ❌ 失败
7. FAB 缓存系统: ✅ 通过 / ❌ 失败

**发现的问题**:
1. [问题描述]
2. [问题描述]

**建议**:
- [建议1]
- [建议2]

**结论**: ✅ 可以合并 / ❌ 需要修复 / ⚠️  有保留意见
```

---

**最后更新**: 2026-02-16
