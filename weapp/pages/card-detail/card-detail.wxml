<view class="page-card-detail">

  <!-- ===== 加载中 ===== -->
  <view wx:if="{{loading}}" class="loading-center">
    <view class="loading-spinner"></view>
    <text class="loading-text">加载中...</text>
  </view>

  <block wx:if="{{card && !loading}}">

    <!-- ===== 卡牌图片 ===== -->
    <view class="card-image-section">
      <image
        class="card-main-image"
        src="{{displayImage}}"
        mode="aspectFit"
        bindtap="previewImage"
        show-menu-by-longpress
      />
    </view>

    <!-- ===== 卡牌信息 ===== -->
    <view class="card-info-body">

      <!-- 名称 + 法术力费用 / FAB 属性 -->
      <view class="card-title-row">
        <view class="card-titles">
          <text class="card-display-name">{{displayName}}</text>
          <text wx:if="{{displayName !== displayNameEn && !isFab}}" class="card-name-en">{{displayNameEn}}</text>
        </view>
        <!-- MTG mana -->
        <view wx:if="{{!isFab && manaSymbols.length > 0}}" class="mana-row">
          <view wx:for="{{manaSymbols}}" wx:key="*this" class="mana-symbol">{{item}}</view>
        </view>
      </view>

      <!-- FAB 属性标签 -->
      <view wx:if="{{isFab}}" class="fab-stats-row">
        <view wx:if="{{fabCost}}" class="fab-stat-badge fab-stat-cost">
          <text>Cost {{fabCost}}</text>
        </view>
        <view wx:if="{{fabPitch}}" class="fab-stat-badge fab-stat-pitch">
          <text>Pitch {{fabPitch}}</text>
        </view>
        <view wx:if="{{fabPower}}" class="fab-stat-badge fab-stat-power">
          <text>Power {{fabPower}}</text>
        </view>
        <view wx:if="{{fabDefense}}" class="fab-stat-badge fab-stat-defense">
          <text>Defense {{fabDefense}}</text>
        </view>
        <view wx:if="{{fabHealth}}" class="fab-stat-badge fab-stat-health">
          <text>Health {{fabHealth}}</text>
        </view>
      </view>

      <!-- FAB 关键词 -->
      <view wx:if="{{isFab && fabKeywords.length > 0}}" class="fab-keywords-row">
        <text wx:for="{{fabKeywords}}" wx:key="*this" class="fab-keyword-tag">{{item}}</text>
      </view>

      <!-- 牌型 (MTG only) -->
      <text wx:if="{{!isFab && displayTypeLine}}" class="card-type-line">{{displayTypeLine}}</text>

      <!-- 系列 + 稀有度 (MTG) -->
      <view wx:if="{{!isFab}}" class="card-set-row">
        <text class="card-set-name">{{displaySet}}</text>
        <text class="card-rarity" style="color: {{displayRarityColor}};">{{displayRarity}}</text>
      </view>

      <!-- 稀有度 (FAB) -->
      <view wx:if="{{isFab && displayRarity}}" class="card-set-row">
        <text class="card-rarity" style="color: {{displayRarityColor}};">{{displayRarity}}</text>
      </view>

      <!-- 关注 + 加入列表 + 分享 (MTG only for now) -->
      <view wx:if="{{!isFab}}" class="action-row">
        <view
          class="follow-btn {{isFollowed ? 'follow-btn-active' : ''}}"
          bindtap="toggleFollow"
        >
          <text>{{isFollowed ? '★ 已关注' : '☆ 关注'}}</text>
        </view>
        <view class="add-list-btn" bindtap="openListPicker">
          <text>＋ 加入列表</text>
        </view>
        <button class="share-btn" open-type="share">分享</button>
      </view>

      <!-- FAB: 分享按钮 -->
      <view wx:if="{{isFab}}" class="action-row">
        <button class="share-btn" style="flex: 1;" open-type="share">分享</button>
      </view>

      <!-- 分隔线 -->
      <view class="divider"></view>

      <!-- ===== 价格 ===== -->
      <view class="section-header">
        <text class="section-title">◆ 价格</text>
      </view>

      <view class="price-card">
        <!-- 人民币 -->
        <view class="price-row" wx:if="{{priceCny}}">
          <text class="price-label">人民币（估算）</text>
          <text class="price-value">¥{{priceCny}}</text>
        </view>
        <view class="price-row" wx:if="{{priceCnyFoil && !isFab}}">
          <text class="price-label">人民币 闪（估算）</text>
          <text class="price-value">¥{{priceCnyFoil}}</text>
        </view>
        <view class="price-row" wx:if="{{priceJpy}}">
          <text class="price-label">日元（估算）</text>
          <text class="price-value-secondary">¥{{priceJpy}}</text>
        </view>

        <view class="inner-divider" wx:if="{{priceCny && priceUsd}}"></view>

        <!-- 美元 -->
        <view class="price-row" wx:if="{{priceUsd}}">
          <text class="price-label">美元</text>
          <text class="price-value">${{priceUsd}}</text>
        </view>
        <view class="price-row" wx:if="{{priceUsdFoil}}">
          <text class="price-label">美元 闪</text>
          <text class="price-value">${{priceUsdFoil}}</text>
        </view>
        <!-- 欧元 (MTG only) -->
        <view class="price-row" wx:if="{{priceEur && !isFab}}">
          <text class="price-label">欧元</text>
          <text class="price-value-secondary">€{{priceEur}}</text>
        </view>
        <!-- MTGO (MTG only) -->
        <view class="price-row" wx:if="{{priceTix && !isFab}}">
          <text class="price-label">MTGO TIX</text>
          <text class="price-value-secondary">{{priceTix}} TIX</text>
        </view>

        <!-- 无价格 -->
        <view wx:if="{{!priceUsd && !priceCny}}" class="no-price">
          <text class="no-price-text">暂无价格数据</text>
        </view>
      </view>

      <!-- ===== FAB 各版本价格 ===== -->
      <block wx:if="{{isFab && fabPrintings.length > 1}}">
        <view class="section-header" style="margin-top: 8rpx;">
          <text class="section-title">◆ 各版本价格</text>
        </view>
        <view class="price-card">
          <view wx:for="{{fabPrintings}}" wx:key="id" class="price-row">
            <text class="price-label">{{item.id}} {{item.foiling ? '(' + item.foiling + ')' : ''}}</text>
            <text class="price-value" wx:if="{{item.priceUsd}}">${{item.priceUsd}}</text>
            <text class="no-price-text" wx:else>--</text>
          </view>
        </view>
      </block>

      <!-- ===== 价格历史 (MTG only) ===== -->
      <view wx:if="{{!isFab && priceHistory.length > 0}}" class="price-card" style="margin-top: 0; margin-bottom: 20rpx;">
        <text class="subsection-title">90 天历史价格</text>
        <view class="price-history-list">
          <view wx:for="{{priceHistory}}" wx:key="id" wx:if="{{index < 10}}" class="price-history-item">
            <text class="price-history-label">{{item.source}} · {{item.condition || 'NM'}}</text>
            <text class="price-history-val" wx:if="{{item.priceUsd}}">${{item.priceUsd}}</text>
          </view>
        </view>
      </view>

      <!-- ===== 规则文字 ===== -->
      <view wx:if="{{displayOracleText}}" class="oracle-card">
        <text class="subsection-title">{{isFab ? '卡牌文本' : '规则文字'}}</text>
        <text class="oracle-text">{{displayOracleText}}</text>
      </view>

      <!-- 画师 (MTG only) -->
      <view wx:if="{{!isFab && displayArtist}}" class="artist-row">
        <text class="artist-text">绘制：{{displayArtist}}</text>
      </view>

      <!-- 分隔线 -->
      <view wx:if="{{!isFab}}" class="divider"></view>

      <!-- ===== 赛制合法性 (MTG only) ===== -->
      <block wx:if="{{!isFab}}">
        <view class="section-header">
          <text class="section-title">◆ 赛制合法性</text>
        </view>

        <view class="legalities-grid">
          <view wx:for="{{legalities}}" wx:key="format" class="legality-item">
            <text class="legality-format">{{item.format}}</text>
            <text class="legality-status {{item.isLegal ? 'legal' : ''}} {{item.isBanned ? 'banned' : ''}} {{item.isRestricted ? 'restricted' : ''}}">
              {{item.isLegal ? '✓ 合法' : item.isBanned ? '✗ 禁止' : item.isRestricted ? '◐ 限制' : '—'}}
            </text>
          </view>
        </view>
      </block>

      <view style="height: 80rpx;"></view>
    </view>
  </block>

  <!-- ===== 加入列表 Picker Modal ===== -->
  <view wx:if="{{showListPicker}}" class="list-picker-overlay" bindtap="closeListPicker">
    <view class="list-picker-box" catchtap="noop">
      <view class="list-picker-handle"></view>
      <text class="list-picker-title">选择价格列表</text>

      <view wx:if="{{priceLists.length === 0}}" class="list-picker-empty">
        <text class="list-picker-empty-text">暂无列表，请先在"我的"中创建</text>
      </view>

      <view wx:for="{{priceLists}}" wx:key="id" class="list-picker-row" data-id="{{item.id}}" bindtap="addToList">
        <view class="list-picker-icon-wrap">
          <text class="list-picker-icon">≡</text>
        </view>
        <view class="list-picker-info">
          <text class="list-picker-name">{{item.name}}</text>
          <text class="list-picker-count">{{item.itemCount || 0}} 张卡牌</text>
        </view>
        <text class="list-picker-arrow">›</text>
      </view>

      <view class="list-picker-cancel" bindtap="closeListPicker">
        <text>取消</text>
      </view>
    </view>
  </view>

</view>
