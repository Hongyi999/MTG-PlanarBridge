<view class="page-card-detail">
  <!-- Loading -->
  <view wx:if="{{loading}}" class="loading-container" style="min-height: 60vh;">
    <view class="loading-text">Loading card...</view>
  </view>

  <block wx:if="{{card && !loading}}">
    <!-- Card Image -->
    <view class="card-image-section">
      <image
        class="card-main-image"
        src="{{displayImage}}"
        mode="aspectFit"
        bindtap="previewImage"
        show-menu-by-longpress
      />
    </view>

    <!-- Card Info -->
    <view class="container">
      <!-- Name & Mana Cost -->
      <view class="card-title-row">
        <view class="card-titles">
          <text class="card-display-name">{{displayName}}</text>
          <text wx:if="{{displayName !== displayNameEn}}" class="card-name-en">{{displayNameEn}}</text>
        </view>
        <view wx:if="{{manaSymbols.length > 0}}" class="mana-row">
          <view
            wx:for="{{manaSymbols}}"
            wx:key="*this"
            class="mana-symbol"
          >
            {{item}}
          </view>
        </view>
      </view>

      <!-- Type Line -->
      <text class="card-type-line">{{displayTypeLine}}</text>

      <!-- Set & Rarity -->
      <view class="card-set-row">
        <text class="card-set-name">{{displaySet}}</text>
        <text class="card-rarity" style="color: {{displayRarityColor}};">{{displayRarity}}</text>
      </view>

      <!-- Follow Button -->
      <view class="follow-row">
        <view class="{{isFollowed ? 'btn-outline' : 'btn-primary'}}" bindtap="toggleFollow" style="flex: 1; text-align: center;">
          {{isFollowed ? '★ Following' : '☆ Follow Price'}}
        </view>
        <button class="share-btn" open-type="share">Share</button>
      </view>

      <view class="divider"></view>

      <!-- Prices Section -->
      <view class="section-header">
        <text class="section-title">◆ Prices</text>
      </view>

      <view class="card-panel">
        <!-- CNY (Primary for Chinese users) -->
        <view class="price-row" wx:if="{{priceCny}}">
          <text class="price-label">CNY (est.)</text>
          <text class="price-value">¥{{priceCny}}</text>
        </view>
        <view class="price-row" wx:if="{{priceCnyFoil}}">
          <text class="price-label">CNY Foil (est.)</text>
          <text class="price-value">¥{{priceCnyFoil}}</text>
        </view>
        <view class="price-row" wx:if="{{priceJpy}}">
          <text class="price-label">JPY (est.)</text>
          <text class="price-value-secondary">¥{{priceJpy}}</text>
        </view>

        <view class="divider" wx:if="{{priceCny}}"></view>

        <!-- USD -->
        <view class="price-row" wx:if="{{priceUsd}}">
          <text class="price-label">USD</text>
          <text class="price-value">${{priceUsd}}</text>
        </view>
        <view class="price-row" wx:if="{{priceUsdFoil}}">
          <text class="price-label">USD Foil</text>
          <text class="price-value">${{priceUsdFoil}}</text>
        </view>
        <!-- EUR -->
        <view class="price-row" wx:if="{{priceEur}}">
          <text class="price-label">EUR</text>
          <text class="price-value-secondary">€{{priceEur}}</text>
        </view>
        <!-- TIX -->
        <view class="price-row" wx:if="{{priceTix}}">
          <text class="price-label">MTGO TIX</text>
          <text class="price-value-secondary">{{priceTix}} TIX</text>
        </view>

        <view wx:if="{{!priceUsd && !priceCny}}" style="text-align: center; padding: 16rpx 0;">
          <text class="text-muted">No price data available</text>
        </view>
      </view>

      <!-- Price History -->
      <view wx:if="{{priceHistory.length > 0}}" class="card-panel">
        <view class="section-header" style="margin-bottom: 12rpx;">
          <text class="section-title" style="font-size: 28rpx;">Price History (90 days)</text>
        </view>
        <view class="price-history-list">
          <view wx:for="{{priceHistory}}" wx:key="id" wx:if="{{index < 10}}" class="price-history-item">
            <text class="text-muted" style="font-size: 22rpx;">{{item.source}} · {{item.condition || 'NM'}}</text>
            <text class="text-gold" style="font-size: 24rpx;" wx:if="{{item.priceUsd}}">${{item.priceUsd}}</text>
          </view>
        </view>
      </view>

      <!-- Oracle Text -->
      <view wx:if="{{displayOracleText}}" class="card-panel">
        <view class="section-header" style="margin-bottom: 12rpx;">
          <text class="section-title" style="font-size: 28rpx;">Oracle Text</text>
        </view>
        <text class="oracle-text">{{displayOracleText}}</text>
      </view>

      <!-- Artist -->
      <view wx:if="{{displayArtist}}" style="margin-bottom: 24rpx;">
        <text class="text-muted" style="font-size: 24rpx;">Illustrated by {{displayArtist}}</text>
      </view>

      <!-- Legalities -->
      <view class="section-header">
        <text class="section-title">◆ Format Legality</text>
      </view>

      <view class="legalities-grid">
        <view
          wx:for="{{legalities}}"
          wx:key="format"
          class="legality-item"
        >
          <text class="legality-format">{{item.format}}</text>
          <text class="legality-status {{item.isLegal ? 'legal' : ''}} {{item.isBanned ? 'banned' : ''}} {{item.isRestricted ? 'restricted' : ''}}">
            {{item.isLegal ? '✓ Legal' : item.isBanned ? '✗ Banned' : item.isRestricted ? '◐ Restricted' : '—'}}
          </text>
        </view>
      </view>

      <!-- Bottom spacing -->
      <view style="height: 60rpx;"></view>
    </view>
  </block>
</view>
