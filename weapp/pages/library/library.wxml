<view class="page-library">

  <!-- ===== é¡¶éƒ¨æ ‡é¢˜ + æ¸¸æˆåˆ‡æ¢ ===== -->
  <view class="lib-header">
    <text class="page-title">{{currentGame === 'fab' ? 'FAB å¡åº“' : 'å¡ç‰Œåº“'}}</text>
    <view class="header-actions">
      <view class="game-switch-btn" bindtap="toggleGame">
        <text class="game-switch-text">{{currentGame === 'fab' ? 'FAB' : 'MTG'}}</text>
        <text style="font-size: 20rpx; margin-left: 6rpx; color: #8a7a5a;">â‡„</text>
      </view>
      <view wx:if="{{currentGame === 'mtg'}}" class="filter-btn" bindtap="toggleFilters">
        <text class="filter-btn-text">ç­›é€‰</text>
        <text wx:if="{{hasActiveFilters}}" class="filter-dot"></text>
      </view>
    </view>
  </view>

  <!-- ===== æœç´¢æ¡† ===== -->
  <view class="px-container">
    <view class="search-bar">
      <text class="search-icon">ğŸ”</text>
      <input
        class="search-input"
        type="text"
        placeholder="{{currentGame === 'fab' ? 'æœç´¢FABå¡ç‰Œ...' : 'æœç´¢MTGå¡ç‰Œï¼ˆä¸­æ–‡ / ENï¼‰...'}}"
        placeholder-style="color: #8a7a5a; font-size: 28rpx;"
        value="{{searchQuery}}"
        bindinput="onSearchInput"
        bindconfirm="onSearch"
        confirm-type="search"
      />
      <view wx:if="{{searchQuery}}" class="search-clear" bindtap="clearSearch">
        <text style="font-size: 28rpx; color: #8a7a5a;">âœ•</text>
      </view>
    </view>

    <!-- ç»“æœæ•°é‡ -->
    <view wx:if="{{searched && !loading}}" class="results-info">
      <text class="results-text">æ‰¾åˆ° {{totalCards}} å¼ å¡ç‰Œ</text>
    </view>
  </view>

  <!-- ===== ç­›é€‰é¢æ¿ ===== -->
  <view wx:if="{{showFilters}}" class="filters-panel px-container">
    <view class="filters-card">
      <!-- é¢œè‰² -->
      <view class="filter-section">
        <text class="filter-label">é¢œè‰²</text>
        <view class="color-row">
          <view
            wx:for="{{colorOptions}}"
            wx:key="code"
            class="color-btn {{selectedColors.indexOf(item.code) >= 0 ? 'selected' : ''}}"
            style="background-color: {{item.color}};"
            data-code="{{item.code}}"
            bindtap="toggleColor"
          >
            <text wx:if="{{selectedColors.indexOf(item.code) >= 0}}" style="color: white; font-size: 24rpx; font-weight: bold; text-shadow: 0 1rpx 2rpx rgba(0,0,0,0.6);">âœ“</text>
          </view>
        </view>
      </view>

      <!-- ç¨€æœ‰åº¦ -->
      <view class="filter-section">
        <text class="filter-label">ç¨€æœ‰åº¦</text>
        <view class="filter-tags">
          <view
            wx:for="{{rarityOptions}}"
            wx:key="key"
            class="filter-tag {{selectedRarity === item.key ? 'active' : ''}}"
            data-rarity="{{item.key}}"
            bindtap="selectRarity"
          >
            {{item.label}}
          </view>
        </view>
      </view>

      <!-- èµ›åˆ¶ -->
      <view class="filter-section">
        <text class="filter-label">èµ›åˆ¶</text>
        <view class="filter-tags">
          <view
            wx:for="{{formatOptions}}"
            wx:key="key"
            class="filter-tag {{selectedFormat === item.key ? 'active' : ''}}"
            data-format="{{item.key}}"
            bindtap="selectFormat"
          >
            {{item.label}}
          </view>
        </view>
      </view>

      <!-- æ“ä½œæŒ‰é’® -->
      <view class="filter-actions">
        <view class="filter-clear-btn" bindtap="clearFilters">æ¸…é™¤</view>
        <view class="filter-apply-btn" bindtap="onSearch">åº”ç”¨ç­›é€‰</view>
      </view>
    </view>
  </view>

  <!-- ===== åŠ è½½ä¸­ ===== -->
  <view wx:if="{{loading && cards.length === 0}}" class="loading-center">
    <view class="loading-spinner"></view>
    <text class="loading-text">æœç´¢ä¸­...</text>
  </view>

  <!-- ===== å¡ç‰‡åˆ—è¡¨ ===== -->
  <view wx:if="{{cards.length > 0}}" class="card-grid-wrap px-container">
    <view
      wx:for="{{cards}}"
      wx:key="id"
      class="grid-card"
      data-id="{{item.id}}"
      bindtap="onCardTap"
    >
      <image class="grid-card-image" src="{{item.image}}" mode="aspectFill" lazy-load />
      <view class="grid-card-body">
        <text class="grid-card-cn">{{item.nameCn || item.nameEn}}</text>
        <text wx:if="{{item.nameCn}}" class="grid-card-en">{{item.nameEn}}</text>
        <view class="grid-card-meta">
          <text class="grid-card-set">{{item.setCode}}</text>
          <text class="grid-card-rarity" style="color: {{item.rarityColor}};">{{item.rarityName}}</text>
        </view>
        <text class="grid-card-price">{{item.priceCny ? 'Â¥' + item.priceCny : (item.priceUsd ? '$' + item.priceUsd : '--')}}</text>
      </view>
    </view>
  </view>

  <!-- ===== åŠ è½½æ›´å¤š ===== -->
  <view wx:if="{{hasMore && !loading}}" class="load-more-wrap px-container">
    <view class="load-more-btn" bindtap="loadMore">åŠ è½½æ›´å¤š</view>
  </view>
  <view wx:if="{{loading && cards.length > 0}}" class="loading-center" style="padding: 32rpx 0;">
    <view class="loading-spinner"></view>
  </view>

  <!-- ===== æ— ç»“æœ ===== -->
  <view wx:if="{{searched && !loading && cards.length === 0}}" class="empty-state">
    <text class="empty-icon">ğŸ”</text>
    <text class="empty-title">æœªæ‰¾åˆ°ç›¸å…³å¡ç‰Œ</text>
    <text class="empty-sub">è¯•è¯•å…¶ä»–å…³é”®è¯</text>
  </view>

  <!-- ===== åˆå§‹æç¤º ===== -->
  <view wx:if="{{!searched && !loading}}" class="empty-state">
    <text class="empty-icon">ğŸƒ</text>
    <text class="empty-title">æœç´¢{{currentGame === 'fab' ? 'FAB' : 'MTG'}}å¡ç‰Œ</text>
    <text class="empty-sub">æ”¯æŒä¸­æ–‡åç§° / è‹±æ–‡åç§°</text>
  </view>

</view>
