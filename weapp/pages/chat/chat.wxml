<view class="chat-page">

  <!-- ===== Conversations View ===== -->
  <view wx:if="{{view === 'conversations'}}">

    <!-- Search bar -->
    <view class="chat-search-wrap">
      <view class="chat-search-bar">
        <input
          class="chat-search-input"
          placeholder="搜索用户名开始对话..."
          placeholder-style="color: #a89a7a; font-size: 26rpx;"
          value="{{searchQuery}}"
          bindinput="onSearchInput"
        />
        <view wx:if="{{searchQuery}}" class="chat-search-clear" bindtap="clearSearch">✕</view>
      </view>
    </view>

    <!-- Search results -->
    <view wx:if="{{searchQuery.length >= 2}}" class="chat-section">
      <view wx:if="{{searchLoading}}" class="chat-loading-row">
        <view class="chat-spinner"></view>
        <text class="chat-loading-text">搜索中...</text>
      </view>
      <view wx:if="{{!searchLoading && searchResults.length === 0}}" class="chat-empty-small">
        <text>未找到该用户</text>
      </view>
      <view
        wx:for="{{searchResults}}"
        wx:key="id"
        class="user-row"
        data-user="{{item}}"
        bindtap="openThreadFromSearch"
      >
        <view class="user-avatar-wrap">
          <image wx:if="{{item.avatar}}" class="user-avatar" src="{{item.avatar}}" mode="aspectFill" />
          <view wx:else class="user-avatar avatar-ph"><text class="avatar-ph-text">◉</text></view>
        </view>
        <view class="user-info">
          <text class="user-name">{{item.username}}</text>
          <text wx:if="{{item.wechatNickname}}" class="user-nick">{{item.wechatNickname}}</text>
        </view>
        <text class="user-arrow">›</text>
      </view>
    </view>

    <!-- Conversations list -->
    <view wx:if="{{!searchQuery}}">
      <view wx:if="{{convsLoading}}" class="chat-loading-center">
        <view class="chat-spinner"></view>
      </view>

      <view wx:if="{{!convsLoading && conversations.length === 0}}" class="chat-empty">
        <text class="chat-empty-icon">◇</text>
        <text class="chat-empty-title">暂无私信</text>
        <text class="chat-empty-sub">搜索用户名开始对话</text>
      </view>

      <view wx:if="{{!convsLoading && conversations.length > 0}}" class="conv-list">
        <view
          wx:for="{{conversations}}"
          wx:key="user.id"
          class="conv-item"
          data-user="{{item.user}}"
          bindtap="openThreadFromConv"
        >
          <view class="conv-avatar-wrap">
            <image wx:if="{{item.user.avatar}}" class="conv-avatar" src="{{item.user.avatar}}" mode="aspectFill" />
            <view wx:else class="conv-avatar avatar-ph"><text class="avatar-ph-text">◉</text></view>
            <view wx:if="{{item.unreadCount > 0}}" class="unread-badge">
              <text class="unread-text">{{item.unreadCount > 99 ? '99+' : item.unreadCount}}</text>
            </view>
          </view>
          <view class="conv-info">
            <view class="conv-name-row">
              <text class="conv-name">{{item.user.username}}</text>
              <text class="conv-time">{{item.lastTime}}</text>
            </view>
            <text class="conv-last-msg">{{item.lastMessage || '暂无消息'}}</text>
          </view>
        </view>
      </view>
    </view>

  </view>

  <!-- ===== Thread View ===== -->
  <view wx:if="{{view === 'thread'}}" class="thread-view">

    <!-- Thread header -->
    <view class="thread-header">
      <view class="thread-back" bindtap="goBackToConversations">
        <text class="thread-back-icon">‹</text>
        <text class="thread-back-text">返回</text>
      </view>
      <view class="thread-user-info">
        <view class="thread-avatar-wrap">
          <image wx:if="{{currentUser.avatar}}" class="thread-avatar" src="{{currentUser.avatar}}" mode="aspectFill" />
          <view wx:else class="thread-avatar avatar-ph"><text class="avatar-ph-text-sm">◉</text></view>
        </view>
        <view>
          <text class="thread-username">{{currentUser.username}}</text>
          <text wx:if="{{currentUser.wechatNickname}}" class="thread-nick">{{currentUser.wechatNickname}}</text>
        </view>
      </view>
    </view>

    <!-- Messages -->
    <scroll-view
      class="messages-scroll"
      scroll-y
      scroll-into-view="{{scrollToBottom}}"
      scroll-with-animation
    >
      <view wx:if="{{messagesLoading}}" class="chat-loading-center">
        <view class="chat-spinner"></view>
      </view>

      <view wx:if="{{!messagesLoading && messages.length === 0}}" class="chat-empty-small">
        <text class="chat-empty-sub">发送一条消息开始对话</text>
      </view>

      <view wx:for="{{messages}}" wx:key="id" id="msg-{{item.id}}" class="msg-row {{item.isMe ? 'msg-mine' : 'msg-theirs'}}">
        <view class="msg-bubble {{item.isMe ? 'bubble-mine' : 'bubble-theirs'}}">
          <text class="msg-text">{{item.content}}</text>
        </view>
        <text class="msg-time">{{item.time}}</text>
      </view>

      <!-- Spacer for input -->
      <view style="height: 120rpx;"></view>
    </scroll-view>

    <!-- Input bar -->
    <view class="input-bar">
      <input
        class="msg-input"
        placeholder="输入消息..."
        placeholder-style="color: #a89a7a; font-size: 26rpx;"
        value="{{inputText}}"
        bindinput="onInputChange"
        confirm-type="send"
        bindconfirm="sendMessage"
        adjust-position
      />
      <view
        class="send-btn {{inputText ? 'send-active' : 'send-disabled'}}"
        bindtap="sendMessage"
      >
        <text class="send-icon">↑</text>
      </view>
    </view>

  </view>

</view>
